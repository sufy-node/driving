<div class="container">
    <header class="mb-20" style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h1>Daily Attendance</h1>
            <p>Sessions for: <strong><%= selectedDate %></strong></p>
        </div>
        <input type="date" value="<%= selectedDate %>" onchange="window.location.href='?date='+this.value" style="padding: 8px;">
    </header>

    <section class="card">
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Student</th>
                        <th>Vehicle</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    <% if (sessions.length === 0) { %>
                        <tr><td colspan="5" class="text-center">No lessons scheduled for this date.</td></tr>
                    <% } %>
                    <% sessions.forEach(s => { %>
                        <tr>
                            <td><%= s.startTime %> - <%= s.endTime %></td>
                            <td><strong><%= s.studentId?.name %></strong></td>
                            <td><%= s.vehicleId?.name %></td>
                            <td>
                                <span class="badge" style="background: <%= s.status === 'PRESENT' ? 'var(--success-color)' : (s.status === 'ABSENT' ? 'var(--danger-color)' : '#eee') %>; color: <%= s.status === 'PENDING' ? '#333' : '#fff' %>">
                                    <%= s.status %>
                                </span>
                            </td>
                            <td>
                                <% if (s.status === 'PENDING') { %>
                                    <button onclick="markAttendance('<%= s._id %>', 'PRESENT')" class="btn-success" style="padding: 5px 10px;">P</button>
                                    <button onclick="markAttendance('<%= s._id %>', 'ABSENT')" class="btn-danger" style="padding: 5px 10px;">A</button>
                                <% } else { %>
                                    <button onclick="resetAttendance('<%= s._id %>')" class="btn" style="padding: 5px 10px; background: #666;">Reset</button>
                                <% } %>
                            </td>
                        </tr>
                    <% }) %>
                </tbody>
            </table>
        </div>
    </section>
</div>

<script>
async function markAttendance(sessionId, status) {
    const res = await fetch('<%= tenantUrl("/attendance/mark") %>', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ sessionId, status })
    });
    const result = await res.json();
    if (result.success) {
        window.location.reload();
    } else {
        Swal.fire('Error', result.message, 'error');
    }
}

async function resetAttendance(sessionId) {
    const { isConfirmed } = await Swal.fire({
        title: 'Reset Session?',
        text: "This will revert progress and remove any plan extensions.",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Yes, reset it!'
    });

    if (isConfirmed) {
        const res = await fetch('<%= tenantUrl("/attendance/reset") %>', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ sessionId })
        });
        const result = await res.json();
        if (result.success) {
            window.location.reload();
        } else {
            Swal.fire('Error', result.message, 'error');
        }
    }
}
</script>